<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Gerenciamento de Jogadores</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <link rel="stylesheet" href="css/modal.css" />
  <link rel="stylesheet" href="css/pages.css" />
  <link rel="shortcut icon" href="img/ADN_Red.png" type="image/x-icon" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #00bfa5;
      text-align: center;
    }

    .player-list {
      margin-top: 20px;
      background: #161b22;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px #00bfa555;
      max-height: 500px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95em;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #2d333b;
      text-align: left;
      white-space: nowrap;
    }

    th {
      color: #00ffa5;
      position: sticky;
      top: 0;
      background: #161b22;
      z-index: 2;
    }

    tr:hover {
      background-color: #1e252f;
    }

    .add-form, .search-box {
      background: #1c2128;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .add-form input, .add-form select, .search-box input {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 5px;
      outline: none;
      min-width: 120px;
    }

    .add-form button, .search-box button {
      background: #00bfa5;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: bold;
    }

    .add-form button:hover, .search-box button:hover {
      background: #00ffa5;
      color: #000;
    }

    .ban-btn {
      background: #ff4444;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.2s;
    }

    .ban-btn:hover {
      background: #ff7777;
    }

    .unban-btn {
      background: #00bfa5;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.2s;
    }

    .unban-btn:hover {
      background: #00ffa5;
      color: #000;
    }

    #adminLock {
      text-align: center;
      margin-top: 80px;
      font-size: 1.2em;
      color: #ff6666;
      display: none;
    }

    /* üîç Barra de pesquisa */
    .search-box i {
      color: #00ffa5;
      margin-right: 5px;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      table {
        font-size: 0.8em;
      }
      th, td {
        padding: 6px;
      }
    }

.player-list {
  margin-top: 20px;
  background: rgba(22, 27, 34, 0.85);
  backdrop-filter: blur(6px);
  border-radius: 10px;
  box-shadow: 0 0 10px #00bfa555;
  overflow: hidden;
  max-height: 400px; /* altura m√°xima */
  display: flex;
  flex-direction: column;
}

.player-list table {
  width: 100%;
  border-collapse: collapse;
}

.player-list thead {
  background: rgba(0, 191, 165, 0.2);
  color: #00ffa5;
  position: sticky;
  top: 0;
  backdrop-filter: blur(8px);
  z-index: 2;
}

.player-list th,
.player-list td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #2d333b;
  white-space: nowrap;
}

.player-list tbody {
  display: block;
  overflow-y: auto;
  max-height: 340px; /* define scroll interno */
}

.player-list thead, 
.player-list tbody tr {
  display: table;
  width: 100%;
  table-layout: fixed;
}

.player-list tbody::-webkit-scrollbar {
  width: 6px;
}

.player-list tbody::-webkit-scrollbar-thumb {
  background-color: #00bfa5;
  border-radius: 4px;
}

.player-list tbody::-webkit-scrollbar-track {
  background-color: #1b1f25;
}


  </style>
</head>
<body>

<!-- üåê Navbar -->
<div class="navbar">
  <a href="index.html"><i class="fas fa-home"></i> Voltar</a>
  <a href="https://discord.gg/spCcTWFWBR" target="_blank"><i class="fab fa-discord"></i> Discord</a>
</div>

<h1>üéÆ Gerenciamento de Jogadores</h1>
<div id="adminLock">‚õî Acesso negado. Apenas administradores podem ver esta p√°gina.</div>

<!-- üîç Pesquisa -->
<div class="search-box" id="searchBox" style="display:none;">
  <i class="fas fa-search"></i>
  <input type="text" id="searchInput" placeholder="Pesquisar por nome, ID ou tag..." />
  <button onclick="searchPlayers()">Buscar</button>
  <button onclick="loadPlayers()">Limpar</button>
</div>

<!-- ‚ûï Adicionar -->
<div class="add-form" id="adminContent" style="display:none;">
  <input type="text" id="nameInput" placeholder="Nome do jogador" />
  <input type="number" id="idInput" placeholder="ID do jogador" />
  <select id="tagInput">
    <option value="Livre">Livre</option>
    <option value="Banido">Banido</option>
  </select>
  <button id="addBtn">Adicionar</button>
</div>

<!-- üßæ Lista -->
<div class="player-list" id="playerList" style="display:none;">
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>ID</th>
        <th>Tag</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="playersTable">
      <tr><td colspan="4">Carregando jogadores...</td></tr>
    </tbody>
  </table>
</div>



<!-- üîí Controle de acesso -->
<script type="module">
  import { auth, db } from "./js/Auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

  const adminContent = document.getElementById("adminContent");
  const playerList = document.getElementById("playerList");
  const adminLock = document.getElementById("adminLock");
  const searchBox = document.getElementById("searchBox");

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      alert("‚ö†Ô∏è Fa√ßa login para acessar esta p√°gina.");
      window.location.href = "index.html";
      return;
    }

    const ref = doc(db, "users", user.email);
    const snap = await getDoc(ref);

    if (!snap.exists() || snap.data().role !== "admin") {
      adminLock.style.display = "block";
      return;
    }

    // ‚úÖ Exibe tudo
    adminLock.style.display = "none";
    adminContent.style.display = "flex";
    playerList.style.display = "block";
    searchBox.style.display = "flex";
    loadPlayers();
  });
</script>

<!-- ‚öôÔ∏è Scripts da API -->
<script>
  const tableBody = document.getElementById("playersTable");
  const addBtn = document.getElementById("addBtn");
  let allPlayers = [];
async function loadPlayers() {
  tableBody.innerHTML = `<tr><td colspan="4">Carregando...</td></tr>`;
  try {
    const res = await fetch("/api/players");
    const players = await res.json();
    allPlayers = players;
    renderPlayers(players);
    document.querySelector(".player-list tbody").scrollTop = 0; // üÜï
  } catch (err) {
    tableBody.innerHTML = `<tr><td colspan="4">‚ùå Erro: ${err.message}</td></tr>`;
  }
}


  function renderPlayers(players) {
    if (!players.length) {
      tableBody.innerHTML = `<tr><td colspan="4">Nenhum jogador encontrado</td></tr>`;
      return;
    }

    tableBody.innerHTML = players.map(p => `
      <tr>
        <td>${p.Name}</td>
        <td>${p.Id_player}</td>
        <td style="color: ${p.Tag === "Banido" ? "red" : "#00ffa5"};">${p.Tag}</td>
        <td>
          ${p.Tag === "Banido"
            ? `<button class="unban-btn" onclick="toggleBan('${p.Id_player}', 'Livre')">Desbanir</button>`
            : `<button class="ban-btn" onclick="toggleBan('${p.Id_player}', 'Banido')">Banir</button>`}
        </td>
      </tr>
    `).join("");
  }

  function searchPlayers() {
    const query = document.getElementById("searchInput").value.toLowerCase().trim();
    if (!query) return renderPlayers(allPlayers);

    const filtered = allPlayers.filter(p =>
      String(p.Id_player).includes(query) ||
      p.Name.toLowerCase().includes(query) ||
      p.Tag.toLowerCase().includes(query)
    );

    renderPlayers(filtered);
  }

  async function toggleBan(Id_player, newTag) {
    const res = await fetch(`/api/players/${Id_player}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ Tag: newTag }),
    });
    await res.json();
    loadPlayers();
  }

  addBtn.addEventListener("click", async () => {
    const Name = document.getElementById("nameInput").value.trim();
    const Id_player = document.getElementById("idInput").value.trim();
    const Tag = document.getElementById("tagInput").value;
    if (!Name || !Id_player) return alert("‚ö†Ô∏è Preencha todos os campos!");

    const res = await fetch("/api/players", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ Name, Id_player, Tag }),
    });
    await res.json();
    loadPlayers();
  });

  
</script>

</body>
</html>
